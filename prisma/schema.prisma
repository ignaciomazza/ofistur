// prisma/schema.prisma

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL") // runtime v√≠a pool (PgBouncer)
  directUrl         = env("DIRECT_URL") // migraciones/DDL directo (misma DB real que runtime)
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL") // requerido para `migrate dev` en DB remota
}

generator client {
  provider = "prisma-client-js"
}

model Agency {
  id_agency                    Int                            @id @default(autoincrement())
  name                         String
  legal_name                   String
  address                      String?
  phone                        String?
  phones                       String[]                       @default([])
  email                        String?
  social                       Json?
  tax_id                       String
  website                      String?
  foundation_date              DateTime?
  logo_url                     String?
  afip_cert_base64             String?
  afip_key_base64              String?
  billing_owner_agency_id      Int?
  billingOwner                 Agency?                        @relation("AgencyBillingOwner", fields: [billing_owner_agency_id], references: [id_agency])
  billingMembers               Agency[]                       @relation("AgencyBillingOwner")
  transfer_fee_pct             Decimal?                       @db.Decimal(9, 6)
  use_agency_numbers           Boolean                        @default(true)
  creation_date                DateTime                       @default(now())
  arcaConfig                   AgencyArcaConfig?
  arcaConnectionJobs           ArcaConnectionJob[]
  users                        User[]
  bookings                     Booking[]
  travelGroups                 TravelGroup[]
  travelGroupConfig            TravelGroupConfig?
  travelGroupDepartures        TravelGroupDeparture[]
  travelGroupInventories       TravelGroupInventory[]
  travelGroupPassengers        TravelGroupPassenger[]
  travelGroupPaymentTemplates  TravelGroupPaymentTemplate[]
  quotes                       Quote[]
  Client                       Client[]
  SalesTeam                    SalesTeam[]
  Resources                    Resources[]
  Operator                     Operator[]
  investments                  Investment[]
  recurringInvestments         RecurringInvestment[]
  TextPreset                   TextPreset[]
  CommissionRuleSet            CommissionRuleSet[]
  templateConfigs              TemplateConfig[]
  FinanceCurrency              FinanceCurrency[]
  FinanceAccount               FinanceAccount[]
  FinanceAccountOpeningBalance FinanceAccountOpeningBalance[]
  FinanceTransfers             FinanceTransfer[]
  FinanceAccountAdjustments    FinanceAccountAdjustment[]
  FinanceAccountAudits         FinanceAccountAudit[]
  FinanceMonthLocks            FinanceMonthLock[]
  FinanceMonthLockEvents       FinanceMonthLockEvent[]
  FinancePaymentMethod         FinancePaymentMethod[]
  ExpenseCategory              ExpenseCategory[]
  FinanceConfig                FinanceConfig?
  ClientConfig                 ClientConfig?
  billingConfig                AgencyBillingConfig?
  billingAdjustments           AgencyBillingAdjustment[]
  billingCycles                AgencyBillingCycle[]
  billingCharges               AgencyBillingCharge[]
  billingFallbackIntents       AgencyBillingFallbackIntent[]
  billingPaymentReviewCases    AgencyBillingPaymentReviewCase[]
  billingSubscription          AgencyBillingSubscription?
  billingEvents                AgencyBillingEvent[]
  billingFileImportRuns        BillingFileImportRun[]
  storageConfig                AgencyStorageConfig?
  storageUsage                 AgencyStorageUsage?
  files                        FileAsset[]
  Lead                         Lead[]
  Receipt                      Receipt[]
  otherIncomes                 OtherIncome[]
  invoices                     Invoice[]
  creditNotes                  CreditNote[]
  services                     Service[]
  operatorDues                 OperatorDue[]
  clientPayments               ClientPayment[]
  clientPaymentAudits          ClientPaymentAudit[]
  ServiceType                  ServiceType[]
  ServiceCalcConfig            ServiceCalcConfig?
  QuoteConfig                  QuoteConfig?
  PassengerCategory            PassengerCategory[]
  ServiceTypePreset            ServiceTypePreset[]
  ClientRelation               ClientRelation[]
  creditAccounts               CreditAccount[]
  creditEntries                CreditEntry[]
  agencyCounters               AgencyCounter[]

  @@index([billing_owner_agency_id])
}

model AgencyCounter {
  id_counter Int      @id @default(autoincrement())
  id_agency  Int
  key        String
  next_value Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  agency     Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  @@unique([id_agency, key])
  @@index([id_agency])
}

model AgencyArcaConfig {
  id                  Int       @id @default(autoincrement())
  agencyId            Int       @unique
  agency              Agency    @relation(fields: [agencyId], references: [id_agency], onDelete: Cascade)
  taxIdRepresentado   String
  taxIdLogin          String
  alias               String
  certEncrypted       String?
  keyEncrypted        String?
  authorizedServices  String[]  @default([])
  salesPointsDetected Int[]     @default([])
  selectedSalesPoint  Int?
  status              String    @default("pending")
  lastError           String?
  lastOkAt            DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model ArcaConnectionJob {
  id                  Int       @id @default(autoincrement())
  agencyId            Int
  agency              Agency    @relation(fields: [agencyId], references: [id_agency], onDelete: Cascade)
  action              String    @default("connect")
  status              String    @default("pending")
  step                String    @default("create_cert")
  services            String[]  @default([])
  currentServiceIndex Int       @default(0)
  longJobId           String?
  taxIdRepresentado   String
  taxIdLogin          String
  alias               String
  lastError           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  completedAt         DateTime?
}

// User: renombramos las colecciones para que reflejen la intenci√≥n
model User {
  id_user        Int      @id @default(autoincrement())
  agency_user_id Int
  email          String   @unique
  password       String
  role           String
  position       String?
  first_name     String
  last_name      String
  creation_date  DateTime @default(now())
  id_agency      Int
  agency         Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  bookings                          Booking[]
  quotes                            Quote[]
  sales_teams                       UserTeam[]
  clients                           Client[]
  CalendarNote                      CalendarNote[]
  investmentsAsBeneficiary          Investment[]          @relation("InvestmentUser")
  investmentsCreated                Investment[]          @relation("InvestmentCreatedBy")
  recurringInvestmentsAsBeneficiary RecurringInvestment[] @relation("RecurringInvestmentUser")
  recurringInvestmentsCreated       RecurringInvestment[] @relation("RecurringInvestmentCreatedBy")
  TextPreset                        TextPreset[]
  CommissionRuleSet                 CommissionRuleSet[]
  CommissionShare                   CommissionShare[]

  // üëá Relaciones nuevas y con nombre sim√©trico:
  createdDestinations                Destination[]                @relation("DestinationCreatedBy")
  serviceDestinationsAdded           ServiceDestination[]         @relation("ServiceDestinationAddedBy")
  creditEntries                      CreditEntry[]
  verifiedReceipts                   Receipt[]                    @relation("ReceiptVerifiedBy")
  verifiedOtherIncomes               OtherIncome[]                @relation("OtherIncomeVerifiedBy")
  createdFiles                       FileAsset[]                  @relation("FileCreatedBy")
  createdOtherIncomes                OtherIncome[]                @relation("OtherIncomeCreatedBy")
  paidClientPayments                 ClientPayment[]              @relation("ClientPaymentPaidBy")
  clientPaymentAudits                ClientPaymentAudit[]         @relation("ClientPaymentAuditChangedBy")
  createdTravelGroups                TravelGroup[]                @relation("TravelGroupCreatedBy")
  createdTravelGroupPaymentTemplates TravelGroupPaymentTemplate[] @relation("TravelGroupPaymentTemplateCreatedBy")
  loadedBillingFxRates               BillingFxRate[]
  billingEventsCreated               AgencyBillingEvent[]
  billingJobRunsCreated              BillingJobRun[]              @relation("BillingJobRunCreatedBy")
  billingPaymentReviewCasesResolved  AgencyBillingPaymentReviewCase[] @relation("BillingReviewCaseResolvedBy")
  billingFileImportRunsUploaded      BillingFileImportRun[]       @relation("BillingFileImportRunUploadedBy")

  @@unique([id_agency, agency_user_id], name: "agency_user_id_unique")
}

model Client {
  id_client                  Int                     @id @default(autoincrement())
  agency_client_id           Int?
  profile_key                String                  @default("persona")
  first_name                 String
  last_name                  String
  phone                      String
  address                    String?
  postal_code                String?
  locality                   String?
  company_name               String?
  tax_id                     String?
  commercial_address         String?
  dni_number                 String?
  passport_number            String?
  birth_date                 DateTime
  nationality                String
  gender                     String
  category_id                Int?
  category                   PassengerCategory?      @relation(fields: [category_id], references: [id_category], onDelete: SetNull)
  email                      String?
  custom_fields              Json?
  nationality_country_id     Int?
  nationalityCountry         Country?                @relation(fields: [nationality_country_id], references: [id_country])
  registration_date          DateTime                @default(now())
  id_agency                  Int
  agency                     Agency                  @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  id_user                    Int
  user                       User                    @relation(fields: [id_user], references: [id_user], onDelete: Cascade)
  bookings                   Booking[]               @relation("BookingClients")
  titular_bookings           Booking[]               @relation("Titular")
  invoices                   Invoice[]               @relation("ClientInvoices")
  ClientPayment              ClientPayment[]
  creditAccounts             CreditAccount[]
  files                      FileAsset[]             @relation("ClientFiles")
  simple_companion_templates ClientSimpleCompanion[]
  relations                  ClientRelation[]        @relation("ClientRelationClient")
  related_to                 ClientRelation[]        @relation("ClientRelationRelated")
  travelGroupPassengers      TravelGroupPassenger[]

  @@unique([id_agency, agency_client_id], name: "agency_client_id_unique")
  @@index([id_agency, profile_key])
}

model Booking {
  id_booking                      Int                           @id @default(autoincrement())
  agency_booking_id               Int?
  clientStatus                    String                        @map("client_status")
  operatorStatus                  String                        @map("operator_status")
  status                          String
  details                         String
  sale_totals                     Json?
  use_booking_sale_total_override Boolean?
  commission_overrides            Json?
  invoice_type                    String
  invoice_observation             String?
  observation                     String?
  creation_date                   DateTime                      @default(now())
  id_user                         Int
  user                            User                          @relation(fields: [id_user], references: [id_user])
  id_agency                       Int
  agency                          Agency                        @relation(fields: [id_agency], references: [id_agency])
  travel_group_id                 Int?
  travel_group                    TravelGroup?                  @relation("BookingTravelGroup", fields: [travel_group_id], references: [id_travel_group], onDelete: SetNull)
  travel_group_departure_id       Int?
  travel_group_departure          TravelGroupDeparture?         @relation("BookingTravelGroupDeparture", fields: [travel_group_departure_id], references: [id_travel_group_departure], onDelete: SetNull)
  titular_id                      Int
  titular                         Client                        @relation("Titular", fields: [titular_id], references: [id_client])
  clients                         Client[]                      @relation("BookingClients")
  services                        Service[]
  simple_companions               BookingCompanion[]
  departure_date                  DateTime
  return_date                     DateTime
  pax_count                       Int
  invoices                        Invoice[]                     @relation("BookingInvoices")
  Receipt                         Receipt[]                     @relation("BookingReceipt")
  investments                     Investment[]                  @relation("BookingInvestments")
  investmentAllocations           InvestmentServiceAllocation[]
  OperatorDue                     OperatorDue[]
  ClientPayment                   ClientPayment[]
  travelGroupPassengers           TravelGroupPassenger[]        @relation("BookingTravelGroupPassenger")
  creditEntries                   CreditEntry[]
  files                           FileAsset[]                   @relation("BookingFiles")

  @@unique([id_agency, agency_booking_id], name: "agency_booking_id_unique")
  @@index([id_agency, id_booking], name: "agency_booking_idx")
  @@index([travel_group_id])
  @@index([travel_group_departure_id])
}

model TravelGroup {
  id_travel_group        Int    @id @default(autoincrement())
  agency_travel_group_id Int?
  id_agency              Int
  agency                 Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  id_user                Int
  createdBy              User   @relation("TravelGroupCreatedBy", fields: [id_user], references: [id_user], onDelete: Restrict)

  name        String
  code        String?
  type        String
  status      String    @default("BORRADOR")
  description String?
  note        String?
  start_date  DateTime?
  end_date    DateTime?
  currency    String?

  capacity_mode     String  @default("TOTAL")
  capacity_total    Int?
  allow_overbooking Boolean @default(false)
  overbooking_limit Int?
  waitlist_enabled  Boolean @default(false)
  waitlist_limit    Int?

  sale_mode     String?
  custom_fields Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  bookings    Booking[]              @relation("BookingTravelGroup")
  departures  TravelGroupDeparture[]
  inventories TravelGroupInventory[]
  passengers  TravelGroupPassenger[]

  @@unique([id_agency, agency_travel_group_id], name: "agency_travel_group_id_unique")
  @@index([id_agency, status])
  @@index([id_agency, type])
  @@index([id_user])
}

model TravelGroupDeparture {
  id_travel_group_departure        Int         @id @default(autoincrement())
  agency_travel_group_departure_id Int?
  id_agency                        Int
  agency                           Agency      @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  travel_group_id                  Int
  travelGroup                      TravelGroup @relation(fields: [travel_group_id], references: [id_travel_group], onDelete: Cascade)

  name              String
  code              String?
  status            String    @default("BORRADOR")
  departure_date    DateTime
  return_date       DateTime?
  release_date      DateTime?
  capacity_total    Int?
  allow_overbooking Boolean?
  overbooking_limit Int?
  waitlist_enabled  Boolean?
  waitlist_limit    Int?
  price_list        Json?
  note              String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  bookings    Booking[]              @relation("BookingTravelGroupDeparture")
  inventories TravelGroupInventory[]
  passengers  TravelGroupPassenger[]

  @@unique([id_agency, agency_travel_group_departure_id], name: "agency_travel_group_departure_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([departure_date])
  @@index([status])
}

model TravelGroupInventory {
  id_travel_group_inventory        Int                   @id @default(autoincrement())
  agency_travel_group_inventory_id Int?
  id_agency                        Int
  agency                           Agency                @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  travel_group_id                  Int
  travelGroup                      TravelGroup           @relation(fields: [travel_group_id], references: [id_travel_group], onDelete: Cascade)
  travel_group_departure_id        Int?
  travelGroupDeparture             TravelGroupDeparture? @relation(fields: [travel_group_departure_id], references: [id_travel_group_departure], onDelete: Cascade)

  inventory_type String
  service_type   String?
  label          String
  provider       String?
  locator        String?
  total_qty      Int
  assigned_qty   Int      @default(0)
  confirmed_qty  Int      @default(0)
  blocked_qty    Int      @default(0)
  currency       String?
  unit_cost      Decimal? @db.Decimal(18, 2)
  note           String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_travel_group_inventory_id], name: "agency_travel_group_inventory_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
}

model TravelGroupPassenger {
  id_travel_group_passenger        Int                   @id @default(autoincrement())
  agency_travel_group_passenger_id Int?
  id_agency                        Int
  agency                           Agency                @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  travel_group_id                  Int
  travelGroup                      TravelGroup           @relation(fields: [travel_group_id], references: [id_travel_group], onDelete: Cascade)
  travel_group_departure_id        Int?
  travelGroupDeparture             TravelGroupDeparture? @relation(fields: [travel_group_departure_id], references: [id_travel_group_departure], onDelete: SetNull)
  booking_id                       Int?
  booking                          Booking?              @relation("BookingTravelGroupPassenger", fields: [booking_id], references: [id_booking], onDelete: SetNull)
  client_id                        Int?
  client                           Client?               @relation(fields: [client_id], references: [id_client], onDelete: SetNull)

  status            String @default("PENDIENTE")
  waitlist_position Int?
  metadata          Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_travel_group_passenger_id], name: "agency_travel_group_passenger_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
  @@index([booking_id])
  @@index([client_id])
  @@index([status])
}

model TravelGroupConfig {
  id_travel_group_config      Int      @id @default(autoincrement())
  id_agency                   Int      @unique
  agency                      Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  required_fields_agencia     String[] @default([])
  required_fields_estudiantil String[] @default([])
  required_fields_precomprado String[] @default([])
  capacity_options            String[] @default(["TOTAL", "SERVICIO", "OVERBOOKING", "WAITLIST"])
  default_capacity_mode       String   @default("TOTAL")
  default_allow_overbooking   Boolean  @default(false)
  default_waitlist_enabled    Boolean  @default(false)
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt
}

model TravelGroupPaymentTemplate {
  id_travel_group_payment_template        Int    @id @default(autoincrement())
  agency_travel_group_payment_template_id Int?
  id_agency                               Int
  agency                                  Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  created_by                              Int?
  createdBy                               User?  @relation("TravelGroupPaymentTemplateCreatedBy", fields: [created_by], references: [id_user], onDelete: SetNull)

  name              String
  description       String?
  target_type       String?
  payment_mode      String?
  is_active         Boolean @default(true)
  is_preloaded      Boolean @default(false)
  assigned_user_ids Int[]   @default([])
  installments      Json
  metadata          Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_travel_group_payment_template_id], name: "agency_travel_group_payment_template_id_unique")
  @@index([id_agency, is_active])
  @@index([id_agency, target_type])
  @@index([created_by])
}

model TravelGroupClientPayment {
  id_travel_group_client_payment        Int       @id @default(autoincrement())
  agency_travel_group_client_payment_id Int?
  id_agency                             Int
  travel_group_id                       Int
  travel_group_departure_id             Int?
  travel_group_passenger_id             Int
  client_id                             Int
  concept                               String?
  service_ref                           String?
  amount                                Decimal   @db.Decimal(18, 2)
  currency                              String
  due_date                              DateTime
  status                                String    @default("PENDIENTE")
  paid_at                               DateTime?
  paid_by                               Int?
  status_reason                         String?
  receipt_id                            Int?
  metadata                              Json?
  created_at                            DateTime  @default(now())
  updated_at                            DateTime  @updatedAt

  @@unique([id_agency, agency_travel_group_client_payment_id], name: "agency_travel_group_client_payment_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
  @@index([travel_group_passenger_id])
  @@index([client_id])
  @@index([due_date])
  @@index([status])
}

model TravelGroupReceipt {
  id_travel_group_receipt        Int      @id @default(autoincrement())
  agency_travel_group_receipt_id Int?
  id_agency                      Int
  travel_group_id                Int
  travel_group_departure_id      Int?
  travel_group_passenger_id      Int
  client_id                      Int
  issue_date                     DateTime @default(now())
  amount                         Decimal  @db.Decimal(18, 2)
  amount_string                  String
  amount_currency                String
  concept                        String
  currency                       String
  payment_method                 String?
  payment_fee_amount             Decimal? @db.Decimal(18, 2)
  account                        String?
  base_amount                    Decimal? @db.Decimal(18, 2)
  base_currency                  String?
  counter_amount                 Decimal? @db.Decimal(18, 2)
  counter_currency               String?
  client_ids                     Int[]    @default([])
  service_refs                   Int[]    @default([])
  metadata                       Json?
  created_at                     DateTime @default(now())
  updated_at                     DateTime @updatedAt

  @@unique([id_agency, agency_travel_group_receipt_id], name: "agency_travel_group_receipt_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
  @@index([travel_group_passenger_id])
  @@index([client_id])
  @@index([issue_date])
}

model TravelGroupOperatorDue {
  id_travel_group_operator_due        Int      @id @default(autoincrement())
  agency_travel_group_operator_due_id Int?
  id_agency                           Int
  travel_group_id                     Int
  travel_group_departure_id           Int?
  travel_group_passenger_id           Int?
  operator_id                         Int?
  concept                             String
  service_ref                         String?
  due_date                            DateTime
  status                              String   @default("PENDIENTE")
  amount                              Decimal  @db.Decimal(18, 2)
  currency                            String
  metadata                            Json?
  created_at                          DateTime @default(now())
  updated_at                          DateTime @updatedAt

  @@unique([id_agency, agency_travel_group_operator_due_id], name: "agency_travel_group_operator_due_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
  @@index([travel_group_passenger_id])
  @@index([operator_id])
  @@index([due_date])
  @@index([status])
}

model TravelGroupOperatorPayment {
  id_travel_group_operator_payment        Int       @id @default(autoincrement())
  agency_travel_group_operator_payment_id Int?
  id_agency                               Int
  travel_group_id                         Int
  travel_group_departure_id               Int?
  travel_group_passenger_id               Int?
  operator_id                             Int?
  category                                String
  description                             String
  amount                                  Decimal   @db.Decimal(18, 2)
  currency                                String
  paid_at                                 DateTime?
  payment_method                          String?
  account                                 String?
  base_amount                             Decimal?  @db.Decimal(18, 2)
  base_currency                           String?
  counter_amount                          Decimal?  @db.Decimal(18, 2)
  counter_currency                        String?
  service_refs                            Int[]     @default([])
  payload                                 Json?
  created_by                              Int?
  created_at                              DateTime  @default(now())
  updated_at                              DateTime  @updatedAt

  @@unique([id_agency, agency_travel_group_operator_payment_id], name: "agency_travel_group_operator_payment_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
  @@index([travel_group_passenger_id])
  @@index([operator_id])
  @@index([created_at])
}

model TravelGroupInvoice {
  id_travel_group_invoice        Int      @id @default(autoincrement())
  agency_travel_group_invoice_id Int?
  id_agency                      Int
  travel_group_id                Int
  travel_group_departure_id      Int?
  travel_group_passenger_id      Int?
  client_id                      Int
  issue_date                     DateTime @default(now())
  invoice_number                 String
  total_amount                   Decimal  @db.Decimal(18, 2)
  currency                       String
  status                         String
  type                           String
  recipient                      String
  exchange_rate                  Decimal? @db.Decimal(18, 6)
  tipo_factura                   Int?
  service_refs                   Int[]    @default([])
  payload_afip                   Json?
  metadata                       Json?
  created_at                     DateTime @default(now())
  updated_at                     DateTime @updatedAt

  @@unique([id_agency, agency_travel_group_invoice_id], name: "agency_travel_group_invoice_id_unique")
  @@index([id_agency, travel_group_id])
  @@index([travel_group_departure_id])
  @@index([travel_group_passenger_id])
  @@index([client_id])
  @@index([issue_date])
}

model TravelGroupInvoiceItem {
  id_travel_group_invoice_item Int      @id @default(autoincrement())
  travel_group_invoice_id      Int
  description                  String
  tax_category                 String
  amount                       Decimal? @db.Decimal(18, 2)
  metadata                     Json?
  created_at                   DateTime @default(now())
  updated_at                   DateTime @updatedAt

  @@index([travel_group_invoice_id])
}

model Quote {
  id_quote        Int      @id @default(autoincrement())
  agency_quote_id Int?
  id_agency       Int
  agency          Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  id_user         Int
  user            User     @relation(fields: [id_user], references: [id_user], onDelete: Cascade)
  lead_name       String?
  lead_phone      String?
  lead_email      String?
  note            String?
  booking_draft   Json?
  pax_drafts      Json?
  service_drafts  Json?
  custom_values   Json?
  creation_date   DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@unique([id_agency, agency_quote_id], name: "agency_quote_id_unique")
  @@index([id_agency, id_quote], name: "agency_quote_idx")
  @@index([id_agency, id_user], name: "agency_quote_owner_idx")
}

model Service {
  id_service                Int                           @id @default(autoincrement())
  agency_service_id         Int?
  type                      String
  description               String
  note                      String?
  sale_price                Float
  cost_price                Float
  destination               String
  reference                 String
  tax_21                    Float?
  tax_105                   Float?
  exempt                    Float?
  other_taxes               Float?
  currency                  String
  nonComputable             Float?
  taxableBase21             Float?
  taxableBase10_5           Float?
  commissionExempt          Float?
  commission21              Float?
  commission10_5            Float?
  vatOnCommission21         Float?
  vatOnCommission10_5       Float?
  totalCommissionWithoutVAT Float?
  impIVA                    Float?
  card_interest             Float?
  card_interest_21          Float?
  taxableCardInterest       Float?
  vatOnCardInterest         Float?
  transfer_fee_pct          Decimal?                      @db.Decimal(9, 6)
  transfer_fee_amount       Decimal?                      @db.Decimal(14, 2)
  billing_override          Json?
  extra_costs_amount        Float?
  extra_taxes_amount        Float?
  extra_adjustments         Json?
  departure_date            DateTime
  return_date               DateTime
  ServiceDestination        ServiceDestination[] // ‚Üê NUEVO (para includes)
  created_at                DateTime                      @default(now())
  booking_id                Int
  booking                   Booking                       @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)
  id_agency                 Int
  agency                    Agency                        @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  id_operator               Int
  operator                  Operator                      @relation(fields: [id_operator], references: [id_operator], onDelete: Cascade)
  InvoiceItem               InvoiceItem[]
  OperatorDue               OperatorDue[]
  clientPayments            ClientPayment[]
  investmentAllocations     InvestmentServiceAllocation[]
  files                     FileAsset[]                   @relation("ServiceFiles")

  @@unique([id_agency, agency_service_id], name: "agency_service_id_unique")
  @@index([id_agency])
}

// ===================== NUEVO =====================
model Country {
  id_country  Int           @id @default(autoincrement())
  name        String
  iso2        String        @unique // AR, US, MX...
  iso3        String?
  slug        String        @unique // "argentina", "estados-unidos"
  enabled     Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  Destination Destination[]
  Client      Client[]
}

// Destination: vincula al creador con nombre de relaci√≥n
model Destination {
  id_destination Int      @id @default(autoincrement())
  name           String
  slug           String
  alt_names      String[] @default([])
  popularity     Int      @default(0)
  enabled        Boolean  @default(true)

  country_id Int
  country    Country @relation(fields: [country_id], references: [id_country], onDelete: Restrict)

  created_by Int?
  createdBy  User? @relation("DestinationCreatedBy", fields: [created_by], references: [id_user])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  ServiceDestination ServiceDestination[]

  @@unique([country_id, slug], name: "country_id_slug")
  @@index([popularity])
  @@index([enabled])
  // (opcional, recomendados sin extensiones)
  @@index([slug])
  @@index([country_id, slug])
}

// ServiceDestination: una sola relaci√≥n a User (addedBy), sin "User/userId_user" extra
model ServiceDestination {
  service_id     Int
  destination_id Int

  service     Service     @relation(fields: [service_id], references: [id_service], onDelete: Cascade)
  destination Destination @relation(fields: [destination_id], references: [id_destination], onDelete: Restrict)

  added_by Int?
  addedBy  User?    @relation("ServiceDestinationAddedBy", fields: [added_by], references: [id_user])
  added_at DateTime @default(now())

  @@id([service_id, destination_id])
  @@index([service_id])
  @@index([destination_id])
}

model Operator {
  id_operator          Int                   @id @default(autoincrement())
  agency_operator_id   Int
  name                 String
  email                String?
  phone                String?
  website              String?
  address              String?
  postal_code          String?
  city                 String?
  state                String?
  country              String?
  vat_status           String?
  legal_name           String?
  tax_id               String?
  registration_date    DateTime              @default(now())
  credit_balance       Float                 @default(0)
  debit_balance        Float                 @default(0)
  services             Service[]
  id_agency            Int
  agency               Agency                @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  Investment           Investment[]
  recurringInvestments RecurringInvestment[]
  creditAccounts       CreditAccount[]
  otherIncomes         OtherIncome[]
  serviceTypePresets   ServiceTypePreset[]

  @@unique([id_agency, agency_operator_id], name: "agency_operator_id_unique")
}

model Invoice {
  id_invoice        Int           @id @default(autoincrement())
  agency_invoice_id Int
  invoice_number    String
  pto_vta           Int           @default(0)
  cbte_tipo         Int           @default(0)
  issue_date        DateTime      @default(now())
  total_amount      Float
  currency          String
  status            String
  type              String
  recipient         String
  facturaHtml       String?
  payloadAfip       Json?
  id_agency         Int
  agency            Agency        @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  bookingId_booking Int
  booking           Booking       @relation("BookingInvoices", fields: [bookingId_booking], references: [id_booking])
  client_id         Int
  client            Client        @relation("ClientInvoices", fields: [client_id], references: [id_client])
  credit_notes      CreditNote[]
  InvoiceItem       InvoiceItem[]

  @@unique([id_agency, agency_invoice_id], name: "agency_invoice_id_unique")
  @@unique([id_agency, pto_vta, cbte_tipo, invoice_number], name: "agency_invoice_voucher_unique")
  @@index([id_agency])
}

model InvoiceItem {
  id                  Int      @id @default(autoincrement())
  invoiceId           Int
  invoice             Invoice  @relation(fields: [invoiceId], references: [id_invoice], onDelete: Cascade)
  serviceId           Int?
  service             Service? @relation(fields: [serviceId], references: [id_service])
  description         String
  sale_price          Float
  taxableBase21       Float
  commission21        Float
  tax_21              Float
  vatOnCommission21   Float
  taxableBase10_5     Float?
  commission10_5      Float?
  tax_105             Float?
  vatOnCommission10_5 Float?
  taxableCardInterest Float?
  vatOnCardInterest   Float?
}

model CreditNote {
  id_credit_note        Int              @id @default(autoincrement())
  agency_credit_note_id Int
  credit_number         String           @unique
  issue_date            DateTime         @default(now())
  total_amount          Float
  currency              String
  status                String
  type                  String
  recipient             String
  payloadAfip           Json?
  id_agency             Int
  agency                Agency           @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  invoiceId             Int
  invoice               Invoice          @relation(fields: [invoiceId], references: [id_invoice])
  items                 CreditNoteItem[]

  @@unique([id_agency, agency_credit_note_id], name: "agency_credit_note_id_unique")
  @@index([id_agency])
}

model CreditNoteItem {
  id                  Int        @id @default(autoincrement())
  creditNoteId        Int
  creditNote          CreditNote @relation(fields: [creditNoteId], references: [id_credit_note], onDelete: Cascade)
  serviceId           Int?
  description         String
  sale_price          Float
  taxableBase21       Float
  commission21        Float
  tax_21              Float
  vatOnCommission21   Float
  taxableBase10_5     Float?
  commission10_5      Float?
  tax_105             Float?
  vatOnCommission10_5 Float?
  taxableCardInterest Float?
  vatOnCardInterest   Float?
}

model SalesTeam {
  id_team              Int        @id @default(autoincrement())
  agency_sales_team_id Int
  name                 String
  user_teams           UserTeam[]
  id_agency            Int
  agency               Agency     @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  @@unique([id_agency, agency_sales_team_id], name: "agency_sales_team_id_unique")
}

model UserTeam {
  id_user_team Int       @id @default(autoincrement())
  id_user      Int
  id_team      Int
  user         User      @relation(fields: [id_user], references: [id_user])
  sales_team   SalesTeam @relation(fields: [id_team], references: [id_team], onDelete: Cascade)
}

model Receipt {
  id_receipt        Int      @id @default(autoincrement())
  agency_receipt_id Int?
  receipt_number    String   @unique
  issue_date        DateTime @default(now())

  // Neto que entra a la agencia (se mantiene igual)
  amount          Float
  amount_string   String
  amount_currency String

  // NUEVO: costo financiero del medio de pago
  /// Monto que paga el cliente pero retiene el medio de pago
  /// (intereses de tarjeta, comisiones de MP/bancos, etc.).
  /// Misma moneda que amount_currency.
  payment_fee_amount Decimal? @db.Decimal(18, 2)

  verification_status String    @default("PENDING")
  verified_at         DateTime?
  verified_by         Int?
  verifiedBy          User?     @relation("ReceiptVerifiedBy", fields: [verified_by], references: [id_user], onDelete: SetNull)

  concept           String
  currency          String
  payment_method    String?
  account           String?
  base_amount       Decimal? @db.Decimal(18, 2)
  base_currency     String?
  counter_amount    Decimal? @db.Decimal(18, 2)
  counter_currency  String?
  payment_method_id Int?
  account_id        Int?

  payments          ReceiptPayment[]
  clientPayments    ClientPayment[]
  bookingId_booking Int?
  booking           Booking?         @relation("BookingReceipt", fields: [bookingId_booking], references: [id_booking], onDelete: SetNull)
  id_agency         Int?
  agency            Agency?          @relation(fields: [id_agency], references: [id_agency], onDelete: SetNull)
  serviceIds        Int[]
  clientIds         Int[]            @default([])
  creditEntries     CreditEntry[]

  @@unique([id_agency, agency_receipt_id], name: "agency_receipt_id_unique")
  @@index([bookingId_booking])
  @@index([id_agency])
  @@index([verification_status])
  @@index([verified_by])
}

model ReceiptPayment {
  id_receipt_payment Int     @id @default(autoincrement())
  receipt_id         Int
  amount             Decimal @db.Decimal(18, 2)

  payment_method_id Int
  account_id        Int?
  payment_currency  String?
  fee_mode          String?
  fee_value         Decimal? @db.Decimal(18, 6)
  fee_amount        Decimal? @db.Decimal(18, 2)

  receipt Receipt @relation(fields: [receipt_id], references: [id_receipt], onDelete: Cascade)

  @@index([receipt_id])
}

model OtherIncome {
  id_other_income        Int    @id @default(autoincrement())
  agency_other_income_id Int?
  id_agency              Int
  agency                 Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  description        String
  counterparty_type  String?
  counterparty_name  String?
  receipt_to         String?
  reference_note     String?
  amount             Decimal  @db.Decimal(18, 2)
  currency           String
  issue_date         DateTime @default(now())
  payment_fee_amount Decimal? @db.Decimal(18, 2)

  payment_method_id Int?
  account_id        Int?
  category_id       Int?
  category          ExpenseCategory? @relation(fields: [category_id], references: [id_category], onDelete: SetNull)
  operator_id       Int?
  operator          Operator?        @relation(fields: [operator_id], references: [id_operator], onDelete: SetNull)

  verification_status String    @default("PENDING")
  verified_at         DateTime?
  verified_by         Int?
  verifiedBy          User?     @relation("OtherIncomeVerifiedBy", fields: [verified_by], references: [id_user], onDelete: SetNull)

  created_at DateTime @default(now())
  created_by Int?
  createdBy  User?    @relation("OtherIncomeCreatedBy", fields: [created_by], references: [id_user], onDelete: SetNull)

  payments OtherIncomePayment[]

  @@unique([id_agency, agency_other_income_id], name: "agency_other_income_id_unique")
  @@index([id_agency])
  @@index([issue_date])
  @@index([category_id])
  @@index([operator_id])
  @@index([verification_status])
  @@index([verified_by])
}

model OtherIncomePayment {
  id_other_income_payment Int     @id @default(autoincrement())
  other_income_id         Int
  amount                  Decimal @db.Decimal(18, 2)
  payment_method_id       Int
  account_id              Int?

  otherIncome OtherIncome @relation(fields: [other_income_id], references: [id_other_income], onDelete: Cascade)

  @@index([other_income_id])
}

model Resources {
  id_resource        Int      @id @default(autoincrement())
  agency_resource_id Int
  createdAt          DateTime @default(now())
  title              String
  description        String?
  id_agency          Int
  agency             Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  @@unique([id_agency, agency_resource_id], name: "agency_resource_id_unique")
}

model FileAsset {
  id_file        Int    @id @default(autoincrement())
  agency_file_id Int
  id_agency      Int
  agency         Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  booking_id Int?
  booking    Booking? @relation("BookingFiles", fields: [booking_id], references: [id_booking], onDelete: Cascade)
  client_id  Int?
  client     Client?  @relation("ClientFiles", fields: [client_id], references: [id_client], onDelete: Cascade)
  service_id Int?
  service    Service? @relation("ServiceFiles", fields: [service_id], references: [id_service], onDelete: Cascade)

  original_name String
  display_name  String?
  mime_type     String
  size_bytes    BigInt
  storage_key   String
  status        String  @default("pending")

  created_at     DateTime  @default(now())
  created_by     Int?
  createdBy      User?     @relation("FileCreatedBy", fields: [created_by], references: [id_user], onDelete: SetNull)
  downloaded_at  DateTime?
  download_count Int       @default(0)

  @@unique([id_agency, agency_file_id], name: "FileAsset_id_agency_agency_file_id_key")
  @@index([id_agency])
  @@index([booking_id])
  @@index([client_id])
  @@index([service_id])
  @@index([status])
}

model CalendarNote {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  date      DateTime
  createdBy Int
  creator   User     @relation(fields: [createdBy], references: [id_user], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Investment {
  id_investment                 Int                           @id @default(autoincrement())
  agency_investment_id          Int?
  id_agency                     Int
  agency                        Agency                        @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  category                      String
  description                   String
  counterparty_name             String?
  amount                        Decimal                       @db.Decimal(18, 2)
  currency                      String
  created_at                    DateTime                      @default(now())
  paid_at                       DateTime?
  payment_method                String?
  account                       String?
  payment_fee_amount            Decimal?                      @db.Decimal(18, 2)
  base_amount                   Decimal?                      @db.Decimal(18, 2)
  base_currency                 String?
  counter_amount                Decimal?                      @db.Decimal(18, 2)
  counter_currency              String?
  excess_action                 String?
  excess_missing_account_action String?
  operator_id                   Int?
  operator                      Operator?                     @relation(fields: [operator_id], references: [id_operator])
  user_id                       Int?
  user                          User?                         @relation("InvestmentUser", fields: [user_id], references: [id_user])
  created_by                    Int
  createdBy                     User                          @relation("InvestmentCreatedBy", fields: [created_by], references: [id_user])
  booking_id                    Int?
  booking                       Booking?                      @relation("BookingInvestments", fields: [booking_id], references: [id_booking], onDelete: SetNull)
  serviceIds                    Int[]                         @default([])
  recurring_id                  Int?
  recurring                     RecurringInvestment?          @relation(fields: [recurring_id], references: [id_recurring], onDelete: SetNull)
  creditEntries                 CreditEntry[]
  payments                      InvestmentPayment[]
  allocations                   InvestmentServiceAllocation[]

  @@unique([recurring_id, paid_at])
  @@unique([id_agency, agency_investment_id], name: "agency_investment_id_unique")
  @@index([id_agency, category])
  @@index([created_at])
  @@index([paid_at])
  @@index([booking_id])
  @@index([recurring_id])
}

model InvestmentPayment {
  id_investment_payment Int      @id @default(autoincrement())
  investment_id         Int
  amount                Decimal  @db.Decimal(18, 2)
  payment_method        String
  account               String?
  payment_currency      String
  fee_mode              String?
  fee_value             Decimal? @db.Decimal(18, 6)
  fee_amount            Decimal? @db.Decimal(18, 2)

  investment Investment @relation(fields: [investment_id], references: [id_investment], onDelete: Cascade)

  @@index([investment_id])
}

model InvestmentServiceAllocation {
  id_allocation Int        @id @default(autoincrement())
  investment_id Int
  investment    Investment @relation(fields: [investment_id], references: [id_investment], onDelete: Cascade)
  service_id    Int
  service       Service    @relation(fields: [service_id], references: [id_service], onDelete: Cascade)
  booking_id    Int?
  booking       Booking?   @relation(fields: [booking_id], references: [id_booking], onDelete: SetNull)

  payment_currency String
  service_currency String
  amount_payment   Decimal  @db.Decimal(18, 2)
  amount_service   Decimal  @db.Decimal(18, 2)
  fx_rate          Decimal? @db.Decimal(18, 6)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([investment_id, service_id])
  @@index([investment_id])
  @@index([service_id])
  @@index([booking_id])
}

model RecurringInvestment {
  id_recurring                   Int          @id @default(autoincrement())
  agency_recurring_investment_id Int
  id_agency                      Int
  agency                         Agency       @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  category                       String
  description                    String
  amount                         Decimal      @db.Decimal(18, 2)
  currency                       String
  payment_method                 String?
  account                        String?
  base_amount                    Decimal?     @db.Decimal(18, 2)
  base_currency                  String?
  counter_amount                 Decimal?     @db.Decimal(18, 2)
  counter_currency               String?
  operator_id                    Int?
  operator                       Operator?    @relation(fields: [operator_id], references: [id_operator])
  user_id                        Int?
  user                           User?        @relation("RecurringInvestmentUser", fields: [user_id], references: [id_user])
  created_by                     Int
  createdBy                      User         @relation("RecurringInvestmentCreatedBy", fields: [created_by], references: [id_user])
  start_date                     DateTime
  day_of_month                   Int
  interval_months                Int          @default(1)
  last_run                       DateTime?
  active                         Boolean      @default(true)
  created_at                     DateTime     @default(now())
  updated_at                     DateTime     @updatedAt
  investments                    Investment[]

  @@unique([id_agency, agency_recurring_investment_id], name: "agency_recurring_investment_id_unique")
  @@index([id_agency, active])
  @@index([start_date])
  @@index([last_run])
}

model OperatorDue {
  id_due                 Int           @id @default(autoincrement())
  agency_operator_due_id Int?
  created_at             DateTime      @default(now())
  booking_id             Int
  booking                Booking       @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)
  id_agency              Int
  agency                 Agency        @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  service_id             Int
  service                Service       @relation(fields: [service_id], references: [id_service], onDelete: Cascade)
  due_date               DateTime
  concept                String
  status                 String
  amount                 Decimal       @db.Decimal(18, 2)
  currency               String
  creditEntries          CreditEntry[]

  @@unique([id_agency, agency_operator_due_id], name: "agency_operator_due_id_unique")
  @@index([booking_id])
  @@index([service_id])
  @@index([due_date])
  @@index([id_agency])
}

model ClientPayment {
  id_payment               Int                  @id @default(autoincrement())
  agency_client_payment_id Int?
  created_at               DateTime             @default(now())
  booking_id               Int
  booking                  Booking              @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)
  id_agency                Int
  agency                   Agency               @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  client_id                Int
  client                   Client               @relation(fields: [client_id], references: [id_client])
  amount                   Decimal              @db.Decimal(18, 2)
  currency                 String
  due_date                 DateTime
  status                   String               @default("PENDIENTE")
  paid_at                  DateTime?
  paid_by                  Int?
  paidBy                   User?                @relation("ClientPaymentPaidBy", fields: [paid_by], references: [id_user], onDelete: SetNull)
  status_reason            String?
  receipt_id               Int?
  receipt                  Receipt?             @relation(fields: [receipt_id], references: [id_receipt], onDelete: SetNull)
  service_id               Int?
  service                  Service?             @relation(fields: [service_id], references: [id_service], onDelete: SetNull)
  audits                   ClientPaymentAudit[]

  @@unique([id_agency, agency_client_payment_id], name: "agency_client_payment_id_unique")
  @@index([booking_id])
  @@index([client_id])
  @@index([id_agency])
  @@index([due_date])
  @@index([status])
  @@index([receipt_id])
  @@index([service_id])
  @@index([booking_id, status])
}

model ClientPaymentAudit {
  id_audit          Int           @id @default(autoincrement())
  client_payment_id Int
  clientPayment     ClientPayment @relation(fields: [client_payment_id], references: [id_payment], onDelete: Cascade)
  id_agency         Int
  agency            Agency        @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  action            String
  from_status       String?
  to_status         String?
  reason            String?
  changed_by        Int?
  changedBy         User?         @relation("ClientPaymentAuditChangedBy", fields: [changed_by], references: [id_user], onDelete: SetNull)
  changed_at        DateTime      @default(now())
  data              Json?

  @@index([client_payment_id, changed_at])
  @@index([id_agency, changed_at])
  @@index([changed_by])
}

model TemplateConfig {
  id_template               Int      @id @default(autoincrement())
  agency_template_config_id Int
  id_agency                 Int
  agency                    Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  doc_type                  String
  config                    Json
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt

  @@unique([id_agency, doc_type])
  @@unique([id_agency, agency_template_config_id], name: "agency_template_config_id_unique")
  @@index([id_agency])
}

model TextPreset {
  id_preset             Int    @id @default(autoincrement())
  agency_text_preset_id Int
  title                 String // nombre visible de la idea/maqueta
  content               String // el texto a insertar (quote.dateRange o confirmation.servicesText)
  doc_type              String // "quote" | "confirmation"
  data                  Json?

  id_user Int
  user    User @relation(fields: [id_user], references: [id_user], onDelete: Cascade)

  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_user, doc_type, title])
  @@unique([id_agency, agency_text_preset_id], name: "agency_text_preset_id_unique")
  @@index([id_user, doc_type, created_at])
}

model CommissionRuleSet {
  id_rule_set                   Int    @id @default(autoincrement())
  agency_commission_rule_set_id Int
  id_agency                     Int
  agency                        Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  owner_user_id Int
  owner         User @relation(fields: [owner_user_id], references: [id_user], onDelete: Cascade)

  valid_from DateTime @default(now())

  own_pct Decimal @db.Decimal(5, 2)

  shares CommissionShare[]

  @@unique([id_agency, agency_commission_rule_set_id], name: "agency_commission_rule_set_id_unique")
  @@index([id_agency, owner_user_id, valid_from])
}

model CommissionShare {
  id_share    Int               @id @default(autoincrement())
  rule_set_id Int
  ruleSet     CommissionRuleSet @relation(fields: [rule_set_id], references: [id_rule_set], onDelete: Cascade)

  beneficiary_user_id Int
  beneficiary         User @relation(fields: [beneficiary_user_id], references: [id_user], onDelete: Cascade)

  percent Decimal @db.Decimal(5, 2)

  @@unique([rule_set_id, beneficiary_user_id])
}

model FinanceConfig {
  id_config                Int    @id @default(autoincrement())
  agency_finance_config_id Int
  id_agency                Int    @unique
  agency                   Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  default_currency_code                 String
  hide_operator_expenses_in_investments Boolean @default(false)
  receipt_verification_rules            Json?
  section_access_rules                  Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_finance_config_id], name: "agency_finance_config_id_unique")
  @@index([id_agency])
}

model ClientConfig {
  id_config               Int    @id @default(autoincrement())
  agency_client_config_id Int
  id_agency               Int    @unique
  agency                  Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  // "all" (todos), "team" (por equipo), "own" (solo propios)
  visibility_mode       String  @default("all")
  required_fields       Json?
  hidden_fields         Json?
  custom_fields         Json?
  profiles              Json?
  use_simple_companions Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_client_config_id], name: "agency_client_config_id_unique")
  @@index([id_agency])
}

model QuoteConfig {
  id_config              Int    @id @default(autoincrement())
  agency_quote_config_id Int
  id_agency              Int    @unique
  agency                 Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  required_fields Json?
  hidden_fields   Json?
  custom_fields   Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_quote_config_id], name: "agency_quote_config_id_unique")
  @@index([id_agency])
}

model PassengerCategory {
  id_category                  Int    @id @default(autoincrement())
  agency_passenger_category_id Int
  id_agency                    Int
  agency                       Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name       String
  code       String
  min_age    Int?
  max_age    Int?
  ignore_age Boolean @default(false)
  enabled    Boolean @default(true)
  sort_order Int     @default(0)

  companions               BookingCompanion[]
  preset_items             ServiceTypePresetItem[]
  clients                  Client[]
  client_simple_companions ClientSimpleCompanion[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@unique([id_agency, name])
  @@unique([id_agency, agency_passenger_category_id], name: "agency_passenger_category_id_unique")
  @@index([id_agency, enabled])
  @@index([id_agency, sort_order])
}

model BookingCompanion {
  id_companion Int     @id @default(autoincrement())
  booking_id   Int
  booking      Booking @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)

  category_id Int?
  category    PassengerCategory? @relation(fields: [category_id], references: [id_category], onDelete: SetNull)
  age         Int?
  notes       String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([booking_id])
  @@index([category_id])
}

model ClientSimpleCompanion {
  id_template Int    @id @default(autoincrement())
  client_id   Int
  client      Client @relation(fields: [client_id], references: [id_client], onDelete: Cascade)

  category_id Int?
  category    PassengerCategory? @relation(fields: [category_id], references: [id_category], onDelete: SetNull)
  age         Int?
  notes       String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([client_id])
  @@index([category_id])
}

model ServiceTypePreset {
  id_preset                     Int    @id @default(autoincrement())
  agency_service_type_preset_id Int
  id_agency                     Int
  agency                        Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  service_type_id Int
  service_type    ServiceType @relation(fields: [service_type_id], references: [id_service_type], onDelete: Cascade)

  operator_id Int?
  operator    Operator? @relation(fields: [operator_id], references: [id_operator], onDelete: SetNull)

  name       String
  currency   String
  enabled    Boolean @default(true)
  sort_order Int     @default(0)

  items ServiceTypePresetItem[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_service_type_preset_id], name: "agency_service_type_preset_id_unique")
  @@index([id_agency, enabled])
  @@index([service_type_id])
  @@index([operator_id])
}

model ServiceTypePresetItem {
  id_item   Int               @id @default(autoincrement())
  preset_id Int
  preset    ServiceTypePreset @relation(fields: [preset_id], references: [id_preset], onDelete: Cascade)

  category_id Int
  category    PassengerCategory @relation(fields: [category_id], references: [id_category], onDelete: Cascade)

  sale_price      Float
  cost_price      Float
  sale_markup_pct Float?

  @@unique([preset_id, category_id])
  @@index([preset_id])
  @@index([category_id])
}

model ClientRelation {
  id_relation Int    @id @default(autoincrement())
  id_agency   Int
  agency      Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  client_id         Int
  related_client_id Int
  relation_type     String?

  client         Client @relation("ClientRelationClient", fields: [client_id], references: [id_client], onDelete: Cascade)
  related_client Client @relation("ClientRelationRelated", fields: [related_client_id], references: [id_client], onDelete: Cascade)

  created_at DateTime @default(now())

  @@unique([id_agency, client_id, related_client_id])
  @@index([id_agency, client_id])
  @@index([id_agency, related_client_id])
}

model AgencyBillingConfig {
  id_config                Int    @id @default(autoincrement())
  agency_billing_config_id Int
  id_agency                Int    @unique
  agency                   Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  plan_key      String    @default("basico")
  billing_users Int       @default(3)
  user_limit    Int?
  currency      String    @default("USD")
  start_date    DateTime?
  notes         String?
  collections_pd_enabled                 Boolean @default(false)
  collections_dunning_enabled            Boolean @default(false)
  collections_fallback_enabled           Boolean @default(false)
  collections_fallback_provider          String?
  collections_fallback_auto_sync_enabled Boolean @default(false)
  collections_suspended                  Boolean @default(false)
  collections_cutoff_override_hour_ar    Int?
  collections_notes                      String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_billing_config_id], name: "agency_billing_config_id_unique")
  @@index([id_agency])
  @@index([plan_key])
}

model AgencyBillingAdjustment {
  id_adjustment                Int    @id @default(autoincrement())
  agency_billing_adjustment_id Int
  id_agency                    Int
  agency                       Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  kind     String
  mode     String
  value    Decimal @db.Decimal(18, 4)
  currency String?
  label    String?

  starts_at DateTime?
  ends_at   DateTime?
  active    Boolean   @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_billing_adjustment_id], name: "agency_billing_adjustment_id_unique")
  @@index([id_agency, active])
  @@index([id_agency, kind])
  @@index([starts_at])
  @@index([ends_at])
}

model AgencyBillingCycle {
  id_cycle         Int                       @id @default(autoincrement())
  id_agency        Int
  agency           Agency                    @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  subscription_id  Int
  subscription     AgencyBillingSubscription @relation(fields: [subscription_id], references: [id_subscription], onDelete: Cascade)

  anchor_date DateTime
  period_start DateTime
  period_end DateTime
  status      String   @default("FROZEN")

  fx_type             BillingFxType @default(DOLAR_BSP)
  fx_rate_date        DateTime?
  fx_rate_ars_per_usd Decimal?      @db.Decimal(18, 6)

  base_amount_usd     Decimal @default(0) @db.Decimal(18, 2)
  addons_total_usd    Decimal @default(0) @db.Decimal(18, 2)
  discount_pct        Decimal @default(0) @db.Decimal(5, 2)
  discount_amount_usd Decimal @default(0) @db.Decimal(18, 2)
  net_amount_usd      Decimal @default(0) @db.Decimal(18, 2)
  vat_rate            Decimal @default(0.21) @db.Decimal(8, 6)
  vat_amount_usd      Decimal @default(0) @db.Decimal(18, 2)
  total_usd           Decimal @default(0) @db.Decimal(18, 2)
  total_ars           Decimal @default(0) @db.Decimal(18, 2)

  plan_snapshot   Json?
  addons_snapshot Json?
  frozen_at       DateTime?

  charges AgencyBillingCharge[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([subscription_id, anchor_date], name: "agency_billing_cycle_unique")
  @@index([id_agency, anchor_date])
  @@index([status, anchor_date])
}

model AgencyBillingCharge {
  id_charge                Int    @id @default(autoincrement())
  agency_billing_charge_id Int
  id_agency                Int
  agency                   Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  period_start DateTime?
  period_end   DateTime?
  due_date     DateTime?
  status       String    @default("PENDING")
  charge_kind  String    @default("RECURRING")
  label        String?

  base_amount_usd       Decimal @db.Decimal(18, 2)
  adjustments_total_usd Decimal @default(0) @db.Decimal(18, 2)
  total_usd             Decimal @db.Decimal(18, 2)

  paid_amount    Decimal?  @db.Decimal(18, 2)
  paid_currency  String?
  fx_rate        Decimal?  @db.Decimal(18, 6)
  paid_at        DateTime?
  account        String?
  payment_method String?
  notes          String?

  subscription_id       Int?
  subscription          AgencyBillingSubscription?   @relation(fields: [subscription_id], references: [id_subscription], onDelete: SetNull)
  cycle_id              Int?
  cycle                 AgencyBillingCycle?          @relation(fields: [cycle_id], references: [id_cycle], onDelete: SetNull)
  selected_method_id    Int?
  selectedMethod        AgencyBillingPaymentMethod?  @relation("AgencyBillingChargeSelectedMethod", fields: [selected_method_id], references: [id_payment_method], onDelete: SetNull)
  amount_ars_due        Decimal?                     @db.Decimal(18, 2)
  amount_ars_paid       Decimal?                     @db.Decimal(18, 2)
  paid_reference        String?
  reconciliation_status BillingReconciliationStatus?
  idempotency_key       String?
  dunning_stage         Int                        @default(0)
  last_dunning_action_at DateTime?
  fallback_offered_at    DateTime?
  fallback_expires_at    DateTime?
  collection_channel     BillingCollectionChannel? @default(PD_GALICIA)
  paid_via_channel       BillingCollectionChannel?
  overdue_since          DateTime?
  collections_escalated_at DateTime?

  attempts        AgencyBillingAttempt[]
  batchItems      AgencyBillingFileBatchItem[]
  fiscalDocuments AgencyBillingFiscalDocument[]
  fallbackIntents AgencyBillingFallbackIntent[]
  paymentReviewCases AgencyBillingPaymentReviewCase[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_billing_charge_id], name: "agency_billing_charge_id_unique")
  @@unique([id_agency, idempotency_key], name: "agency_billing_charge_idempotency_unique")
  @@unique([cycle_id], name: "agency_billing_charge_cycle_unique")
  @@index([id_agency, status])
  @@index([id_agency, due_date])
  @@index([id_agency, period_start])
  @@index([subscription_id])
  @@index([cycle_id])
  @@index([selected_method_id])
  @@index([reconciliation_status])
  @@index([dunning_stage])
  @@index([paid_via_channel])
}

enum BillingFxType {
  DOLAR_BSP
}

enum BillingSubscriptionStatus {
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELED
}

enum BillingMethodType {
  DIRECT_DEBIT_CBU_GALICIA
  CIG_GALICIA
  MP_FALLBACK
}

enum BillingMethodStatus {
  PENDING
  ACTIVE
  DISABLED
}

enum BillingMandateStatus {
  PENDING
  PENDING_BANK
  ACTIVE
  REVOKED
  REJECTED
  EXPIRED
}

enum BillingAttemptStatus {
  PENDING
  SCHEDULED
  PROCESSING
  PAID
  REJECTED
  FAILED
  CANCELED
}

enum BillingReconciliationStatus {
  PENDING
  MATCHED
  PARTIAL
  UNMATCHED
  ERROR
}

enum BillingCollectionChannel {
  PD_GALICIA
  CIG_QR
  MP
  OTHER
}

enum BillingFallbackProvider {
  CIG_QR
  MP
  OTHER
}

enum BillingFallbackIntentStatus {
  CREATED
  PENDING
  PRESENTED
  PAID
  EXPIRED
  CANCELED
  FAILED
}

enum BillingJobSource {
  CRON
  MANUAL
  SYSTEM
}

enum BillingJobRunStatus {
  RUNNING
  SUCCESS
  PARTIAL
  FAILED
  SKIPPED_LOCKED
  NO_OP
}

enum BillingFileImportRunStatus {
  SUCCESS
  FAILED
  DUPLICATE
  INVALID
}

enum BillingPaymentReviewCaseType {
  LATE_DUPLICATE_PAYMENT
  AMOUNT_MISMATCH
  OTHER
}

enum BillingPaymentReviewCaseStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  IGNORED
}

enum BillingPaymentReviewResolutionType {
  BALANCE_CREDIT
  REFUND_MANUAL
  NO_ACTION
  OTHER
}

model BillingFxRate {
  id_fx_rate  Int           @id @default(autoincrement())
  fx_type     BillingFxType @default(DOLAR_BSP)
  rate_date   DateTime
  ars_per_usd Decimal       @db.Decimal(18, 6)

  loaded_by Int?
  loadedBy  User? @relation(fields: [loaded_by], references: [id_user], onDelete: SetNull)

  note       String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([fx_type, rate_date])
  @@index([rate_date])
}

model AgencyBillingSubscription {
  id_subscription Int    @id @default(autoincrement())
  id_agency       Int    @unique
  agency          Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  status                    BillingSubscriptionStatus @default(ACTIVE)
  anchor_day                Int                       @default(8)
  timezone                  String                    @default("America/Argentina/Buenos_Aires")
  direct_debit_discount_pct Decimal                   @default(10.00) @db.Decimal(5, 2)
  next_anchor_date          DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  paymentMethods AgencyBillingPaymentMethod[]
  cycles         AgencyBillingCycle[]
  charges        AgencyBillingCharge[]
  events         AgencyBillingEvent[]

  @@index([status])
  @@index([next_anchor_date])
}

model AgencyBillingPaymentMethod {
  id_payment_method Int                       @id @default(autoincrement())
  subscription_id   Int
  subscription      AgencyBillingSubscription @relation(fields: [subscription_id], references: [id_subscription], onDelete: Cascade)

  method_type BillingMethodType
  status      BillingMethodStatus @default(PENDING)
  is_default  Boolean             @default(false)

  holder_name   String?
  holder_tax_id String?
  metadata      Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  mandate  AgencyBillingMandate?
  charges  AgencyBillingCharge[]  @relation("AgencyBillingChargeSelectedMethod")
  attempts AgencyBillingAttempt[]

  @@unique([subscription_id, method_type], name: "agency_billing_method_unique")
  @@index([subscription_id, is_default])
}

model AgencyBillingMandate {
  id_mandate        Int                        @id @default(autoincrement())
  payment_method_id Int                        @unique
  paymentMethod     AgencyBillingPaymentMethod @relation(fields: [payment_method_id], references: [id_payment_method], onDelete: Cascade)

  status BillingMandateStatus @default(PENDING)

  cbu_encrypted String
  cbu_last4     String
  cbu_hash      String

  consent_version     String?
  consent_accepted_at DateTime?
  consent_ip          String?

  holder_name String?
  holder_doc  String?

  bank_reference       String?
  activated_at         DateTime?
  rejected_reason_code String?
  rejected_reason_text String?
  revoked_at           DateTime?
  last_status_check_at DateTime?

  // Legacy aliases kept for backward compatibility while migrating callers.
  bank_mandate_ref String?
  rejection_code   String?
  rejection_reason String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([status])
  @@index([cbu_hash])
}

model AgencyBillingAttempt {
  id_attempt Int                 @id @default(autoincrement())
  charge_id  Int
  charge     AgencyBillingCharge @relation(fields: [charge_id], references: [id_charge], onDelete: Cascade)

  payment_method_id Int?
  paymentMethod     AgencyBillingPaymentMethod? @relation(fields: [payment_method_id], references: [id_payment_method], onDelete: SetNull)

  attempt_no Int                  @default(1)
  status     BillingAttemptStatus @default(PENDING)
  channel    String               @default("OFFICE_BANKING")
  external_reference String?
  paid_reference     String?

  scheduled_for DateTime?
  processed_at  DateTime?

  rejection_code   String?
  rejection_reason String?
  notes            String?

  processor_result_code     String?
  processor_result_message  String?
  processor_trace_id        String?
  processor_settlement_date DateTime?
  processor_raw_payload     Json?

  created_at DateTime                 @default(now())
  updated_at DateTime                 @updatedAt
  batchItems AgencyBillingFileBatchItem[]

  @@unique([charge_id, attempt_no], name: "agency_billing_attempt_unique")
  @@index([payment_method_id, status])
  @@index([status, scheduled_for])
  @@index([scheduled_for])
}

model AgencyBillingFallbackIntent {
  id_fallback_intent Int                 @id @default(autoincrement())
  agency_id          Int
  agency             Agency              @relation(fields: [agency_id], references: [id_agency], onDelete: Cascade)
  charge_id          Int
  charge             AgencyBillingCharge @relation(fields: [charge_id], references: [id_charge], onDelete: Cascade)

  provider BillingFallbackProvider
  status   BillingFallbackIntentStatus @default(CREATED)

  amount   Decimal @db.Decimal(18, 2)
  currency String  @default("ARS")

  external_reference    String  @unique
  provider_payment_id   String?
  provider_status       String?
  provider_status_detail String?
  payment_url           String?
  qr_payload            String?
  qr_image_url          String?
  expires_at            DateTime?
  paid_at               DateTime?
  failure_code          String?
  failure_message       String?
  provider_raw_payload  Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([charge_id, provider, status])
  @@index([provider, status])
}

model AgencyBillingEvent {
  id_event  Int    @id @default(autoincrement())
  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  subscription_id Int?
  subscription    AgencyBillingSubscription? @relation(fields: [subscription_id], references: [id_subscription], onDelete: SetNull)

  event_type String
  payload    Json?

  created_by Int?
  createdBy  User? @relation(fields: [created_by], references: [id_user], onDelete: SetNull)

  created_at DateTime @default(now())

  @@index([id_agency, created_at])
  @@index([event_type, created_at])
}

model AgencyBillingFileBatch {
  id_batch        Int      @id @default(autoincrement())
  parent_batch_id Int?
  parentBatch     AgencyBillingFileBatch?  @relation("AgencyBillingFileBatchParent", fields: [parent_batch_id], references: [id_batch], onDelete: SetNull)
  childBatches    AgencyBillingFileBatch[] @relation("AgencyBillingFileBatchParent")

  direction     String
  channel       String
  file_type     String
  adapter       String?
  business_date DateTime

  original_file_name String?
  storage_key        String?
  sha256             String?
  file_hash          String?
  adapter_version    String?
  record_count       Int?
  amount_total       Decimal? @db.Decimal(18, 2)
  exported_at        DateTime?
  imported_at        DateTime?
  status             String @default("CREATED")

  total_rows         Int      @default(0)
  total_amount_ars   Decimal? @db.Decimal(18, 2)
  total_paid_rows    Int      @default(0)
  total_rejected_rows Int     @default(0)
  total_error_rows   Int      @default(0)

  meta Json?

  created_by Int?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  items AgencyBillingFileBatchItem[]
  fileImportRuns BillingFileImportRun[]

  @@index([direction, business_date])
  @@index([status, business_date])
  @@index([parent_batch_id])
  @@unique([direction, sha256], name: "agency_billing_file_batch_unique_sha")
}

model AgencyBillingFileBatchItem {
  id_item    Int                    @id @default(autoincrement())
  batch_id   Int
  batch      AgencyBillingFileBatch @relation(fields: [batch_id], references: [id_batch], onDelete: Cascade)
  attempt_id Int?
  attempt    AgencyBillingAttempt?  @relation(fields: [attempt_id], references: [id_attempt], onDelete: SetNull)
  charge_id  Int?
  charge     AgencyBillingCharge?   @relation(fields: [charge_id], references: [id_charge], onDelete: SetNull)

  line_no            Int?
  external_reference String?
  raw_hash           String?
  amount_ars         Decimal? @db.Decimal(18, 2)
  status             String   @default("PENDING")

  response_code    String?
  response_message String?
  paid_reference   String?
  row_payload      Json?

  processed_at DateTime?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([batch_id, line_no])
  @@index([attempt_id])
  @@index([charge_id])
  @@index([external_reference])
  @@index([raw_hash])
  @@unique([batch_id, attempt_id], name: "agency_billing_file_batch_item_unique_attempt")
}

model AgencyBillingFiscalDocument {
  id_fiscal_document Int                @id @default(autoincrement())
  charge_id          Int
  charge             AgencyBillingCharge @relation(fields: [charge_id], references: [id_charge], onDelete: Cascade)

  document_type String @default("INVOICE_A")
  status        String @default("PENDING")

  afip_pto_vta   Int?
  afip_cbte_tipo Int?
  afip_number    String?
  afip_cae       String?
  afip_cae_due   DateTime?

  external_reference String?
  payload            Json?
  error_message      String?
  retry_count        Int      @default(0)
  issued_at          DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([charge_id, document_type], name: "agency_billing_fiscal_unique")
  @@index([status, created_at])
  @@index([issued_at])
}

model BillingJobRun {
  id_job_run    Int                 @id @default(autoincrement())
  job_name      String
  run_id        String
  source        BillingJobSource    @default(SYSTEM)
  status        BillingJobRunStatus @default(RUNNING)
  started_at    DateTime            @default(now())
  finished_at   DateTime?
  duration_ms   Int?
  target_date_ar String?
  adapter       String?
  counters_json Json?
  error_message String?
  error_stack   String?
  metadata_json Json?

  created_by Int?
  createdBy  User? @relation("BillingJobRunCreatedBy", fields: [created_by], references: [id_user], onDelete: SetNull)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([job_name, started_at])
  @@index([source, started_at])
  @@index([status, started_at])
  @@index([run_id])
}

model BillingFileImportRun {
  id_file_import_run Int                        @id @default(autoincrement())
  agency_id          Int
  agency             Agency                     @relation(fields: [agency_id], references: [id_agency], onDelete: Cascade)
  batch_id           Int?
  batch              AgencyBillingFileBatch?    @relation(fields: [batch_id], references: [id_batch], onDelete: SetNull)
  file_name          String
  file_hash          String
  adapter            String?
  uploaded_by        Int?
  uploadedBy         User?                      @relation("BillingFileImportRunUploadedBy", fields: [uploaded_by], references: [id_user], onDelete: SetNull)
  source             BillingJobSource           @default(MANUAL)
  status             BillingFileImportRunStatus
  detected_totals    Json?
  parsed_rows        Int?
  error_message      String?
  metadata_json      Json?
  created_at         DateTime                   @default(now())
  updated_at         DateTime                   @updatedAt

  @@index([agency_id, created_at])
  @@index([batch_id, created_at])
  @@index([status, created_at])
  @@index([file_hash])
}

model AgencyBillingPaymentReviewCase {
  id_review_case         Int                                @id @default(autoincrement())
  agency_id              Int
  agency                 Agency                             @relation(fields: [agency_id], references: [id_agency], onDelete: Cascade)
  charge_id              Int
  charge                 AgencyBillingCharge                @relation(fields: [charge_id], references: [id_charge], onDelete: Cascade)
  type                   BillingPaymentReviewCaseType
  status                 BillingPaymentReviewCaseStatus     @default(OPEN)
  primary_paid_channel   BillingCollectionChannel?
  secondary_late_channel BillingCollectionChannel?
  amount_ars             Decimal?                           @db.Decimal(18, 2)
  detected_at            DateTime                           @default(now())
  resolution_type        BillingPaymentReviewResolutionType?
  resolution_notes       String?
  resolved_by_user_id    Int?
  resolvedBy             User?                              @relation("BillingReviewCaseResolvedBy", fields: [resolved_by_user_id], references: [id_user], onDelete: SetNull)
  resolved_at            DateTime?
  dedupe_key             String?
  metadata_json          Json?
  created_at             DateTime                           @default(now())
  updated_at             DateTime                           @updatedAt

  @@unique([dedupe_key])
  @@index([agency_id, status])
  @@index([charge_id, status])
  @@index([type, status, detected_at])
  @@index([detected_at])
}

model BillingJobLock {
  id_lock      Int      @id @default(autoincrement())
  lock_key     String   @unique
  acquired_at  DateTime @default(now())
  expires_at   DateTime
  owner_run_id String?
  metadata     Json?
  released_at  DateTime?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([expires_at])
  @@index([released_at])
}

model AgencyStorageConfig {
  id_config Int    @id @default(autoincrement())
  id_agency Int    @unique
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  enabled             Boolean @default(false)
  scope               String  @default("agency") // "agency" | "group"
  storage_pack_count  Int     @default(1)
  transfer_pack_count Int     @default(1)
  notes               String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_agency])
}

model AgencyStorageUsage {
  id_usage  Int    @id @default(autoincrement())
  id_agency Int    @unique
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  storage_bytes  BigInt   @default(0)
  transfer_bytes BigInt   @default(0)
  transfer_month DateTime @default(now())

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_agency])
}

model FinanceCurrency {
  id_currency                Int    @id @default(autoincrement())
  agency_finance_currency_id Int
  id_agency                  Int
  agency                     Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  code       String // ARS, USD
  name       String // Pesos, D√≥lares
  symbol     String?
  decimals   Int     @default(2)
  is_primary Boolean @default(false)

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@unique([id_agency, agency_finance_currency_id], name: "agency_finance_currency_id_unique")
  @@index([id_agency, enabled])
}

model FinanceAccount {
  id_account                Int    @id @default(autoincrement())
  agency_finance_account_id Int
  id_agency                 Int
  agency                    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name     String
  type     String? // bank | wallet | cash (texto libre v1)
  alias    String?
  cbu      String?
  currency String? // opcional

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  openingBalances FinanceAccountOpeningBalance[]

  @@unique([id_agency, name])
  @@unique([id_agency, agency_finance_account_id], name: "agency_finance_account_id_unique")
  @@index([id_agency, enabled])
}

model FinanceAccountOpeningBalance {
  id_opening_balance Int    @id @default(autoincrement())
  id_agency          Int
  agency             Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  account_id Int
  account    FinanceAccount @relation(fields: [account_id], references: [id_account], onDelete: Cascade)

  currency       String
  amount         Decimal  @db.Decimal(18, 2)
  effective_date DateTime
  note           String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, account_id, currency])
  @@index([id_agency])
  @@index([account_id])
}

model FinanceTransfer {
  id_transfer Int    @id @default(autoincrement())
  id_agency   Int
  agency      Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  transfer_date DateTime
  note          String?

  origin_account_id Int?
  origin_method_id  Int?
  origin_currency   String
  origin_amount     Decimal @db.Decimal(18, 2)

  destination_account_id Int?
  destination_method_id  Int?
  destination_currency   String
  destination_amount     Decimal @db.Decimal(18, 2)

  fx_rate Decimal? @db.Decimal(18, 6)

  fee_amount     Decimal? @db.Decimal(18, 2)
  fee_currency   String?
  fee_account_id Int?
  fee_method_id  Int?
  fee_note       String?

  created_by Int?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  deleted_at    DateTime?
  deleted_by    Int?
  delete_reason String?

  @@index([id_agency, transfer_date])
  @@index([id_agency, origin_account_id])
  @@index([id_agency, destination_account_id])
  @@index([id_agency, deleted_at])
}

model FinanceAccountAdjustment {
  id_adjustment Int    @id @default(autoincrement())
  id_agency     Int
  agency        Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  account_id Int
  currency   String
  amount     Decimal @db.Decimal(18, 2)

  effective_date DateTime
  reason         String
  note           String?
  source         String   @default("manual") // manual | audit
  audit_id       Int?

  created_by Int?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_agency, account_id, currency, effective_date])
  @@index([id_agency, effective_date])
  @@index([audit_id])
}

model FinanceAccountAudit {
  id_audit  Int    @id @default(autoincrement())
  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  account_id Int
  currency   String
  year       Int
  month      Int

  expected_balance Decimal @db.Decimal(18, 2)
  actual_balance   Decimal @db.Decimal(18, 2)
  difference       Decimal @db.Decimal(18, 2)

  note              String?
  create_adjustment Boolean @default(false)
  adjustment_id     Int?

  created_by Int?
  created_at DateTime @default(now())

  @@index([id_agency, account_id, currency, year, month])
  @@index([id_agency, year, month])
  @@index([adjustment_id])
}

model FinanceMonthLock {
  id_lock   Int    @id @default(autoincrement())
  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  year      Int
  month     Int
  is_locked Boolean @default(false)
  reason    String?

  locked_by   Int?
  locked_at   DateTime?
  unlocked_by Int?
  unlocked_at DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, year, month])
  @@index([id_agency, is_locked])
}

model FinanceMonthLockEvent {
  id_event  Int    @id @default(autoincrement())
  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  year   Int
  month  Int
  action String // lock | unlock
  reason String?

  acted_by Int?
  acted_at DateTime @default(now())

  @@index([id_agency, year, month, acted_at])
}

model FinancePaymentMethod {
  id_method                        Int    @id @default(autoincrement())
  agency_finance_payment_method_id Int
  id_agency                        Int
  agency                           Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name             String // Efectivo, Transferencia...
  code             String // cash, transfer, credit...
  requires_account Boolean @default(false)

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@unique([id_agency, name])
  @@unique([id_agency, agency_finance_payment_method_id], name: "agency_finance_payment_method_id_unique")
  @@index([id_agency, enabled])
}

enum ExpenseCategoryScope {
  INVESTMENT
  OTHER_INCOME
}

model ExpenseCategory {
  id_category                Int    @id @default(autoincrement())
  agency_expense_category_id Int
  id_agency                  Int
  agency                     Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name              String // "SUELDO", "COMISION", "OPERADOR", etc.
  code              String? // opcional: sueldo | comision | operador | ...
  scope             ExpenseCategoryScope
  requires_operator Boolean              @default(false)
  requires_user     Boolean              @default(false)

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  otherIncomes OtherIncome[]

  @@unique([id_agency, scope, name])
  @@unique([id_agency, agency_expense_category_id], name: "agency_expense_category_id_unique")
  @@index([id_agency, enabled])
  @@index([id_agency, scope, enabled])
}

model ServiceType {
  id_service_type        Int    @id @default(autoincrement())
  agency_service_type_id Int
  id_agency              Int
  agency                 Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  code                 String // slug √∫nico por agencia (ej: "aereos-nacional")
  name                 String // nombre visible (ej: "A√©reos Nacional")
  enabled              Boolean             @default(true)
  allow_no_destination Boolean             @default(false)
  presets              ServiceTypePreset[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@unique([id_agency, name])
  @@unique([id_agency, agency_service_type_id], name: "agency_service_type_id_unique")
  @@index([id_agency, enabled])
}

model ServiceCalcConfig {
  id_config                     Int    @id @default(autoincrement())
  agency_service_calc_config_id Int
  id_agency                     Int    @unique
  agency                        Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  // "auto" para usar BillingBreakdown; "manual" para cargar importes simples
  billing_breakdown_mode  String  @default("auto")
  billing_adjustments     Json?
  use_booking_sale_total  Boolean @default(false)
  // "all" (toda la agencia), "team" (por equipo), "own" (solo propias)
  booking_visibility_mode String  @default("own")
  booking_access_rules    Json?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, agency_service_calc_config_id], name: "agency_service_calc_config_id_unique")
  @@index([id_agency])
}

// ===========================
// Leads (landing > contacto)
// ===========================

model Lead {
  id_lead        Int  @id @default(autoincrement())
  agency_lead_id Int?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Datos del formulario p√∫blico
  full_name   String
  agency_name String
  role        String
  team_size   String?
  location    String?
  email       String
  whatsapp    String?
  message     String? @db.Text
  status      String  @default("PENDING")

  contacted_at DateTime?
  source       String    @default("landing")

  id_agency Int?
  agency    Agency? @relation(fields: [id_agency], references: [id_agency], onDelete: SetNull)

  @@unique([id_agency, agency_lead_id], name: "agency_lead_id_unique")
  @@index([status])
  @@index([created_at])
  @@index([email])
}

model CreditAccount {
  id_credit_account        Int    @id @default(autoincrement())
  agency_credit_account_id Int
  id_agency                Int
  agency                   Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  operator_id Int?
  operator    Operator? @relation(fields: [operator_id], references: [id_operator], onDelete: Cascade)
  client_id   Int?
  client      Client?   @relation(fields: [client_id], references: [id_client], onDelete: Cascade)

  currency String
  balance  Decimal @default(0) @db.Decimal(18, 2)

  enabled    Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  entries CreditEntry[]

  @@unique([id_agency, agency_credit_account_id], name: "agency_credit_account_id_unique")
  @@index([id_agency])
  @@index([operator_id])
  @@index([client_id])
  @@index([currency])
}

model CreditEntry {
  id_entry               Int    @id @default(autoincrement())
  agency_credit_entry_id Int
  id_agency              Int
  agency                 Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  account_id Int
  account    CreditAccount @relation(fields: [account_id], references: [id_credit_account], onDelete: Cascade)

  created_at DateTime  @default(now())
  value_date DateTime?
  concept    String
  amount     Decimal   @db.Decimal(18, 2)
  currency   String

  booking_id Int?
  booking    Booking? @relation(fields: [booking_id], references: [id_booking], onDelete: SetNull)

  receipt_id Int?
  receipt    Receipt? @relation(fields: [receipt_id], references: [id_receipt], onDelete: SetNull)

  investment_id Int?
  investment    Investment? @relation(fields: [investment_id], references: [id_investment], onDelete: SetNull)

  operator_due_id Int?
  operatorDue     OperatorDue? @relation(fields: [operator_due_id], references: [id_due], onDelete: SetNull)

  doc_type  String?
  reference String?

  created_by Int?
  createdBy  User? @relation(fields: [created_by], references: [id_user], onDelete: SetNull)

  @@unique([id_agency, agency_credit_entry_id], name: "agency_credit_entry_id_unique")
  @@index([account_id])
  @@index([id_agency, created_at])
  @@index([booking_id])
  @@index([receipt_id])
  @@index([investment_id])
  @@index([operator_due_id])
}
